#!/bin/sh

ADDONNAME=eufySecurity
CONFIG_DIR=/usr/local/etc/config
ADDON_DIR=/usr/local/addons/${ADDONNAME}
RCD_DIR=${CONFIG_DIR}/rc.d
WWW_DIR=${CONFIG_DIR}/addons/www/${ADDONNAME}

# mount /usr/local if not already mounted
mount | grep /usr/local 2>&1 >/dev/null
if [ $? -eq 1 ]; then
  mount /usr/local
fi

# if the service is available, stop it
# (mainly for raspberrymatic)
if [ -e ${RCD_DIR}/eufySecurity ]; then
  ${RCD_DIR}/eufySecurity stop
fi

# remove unused api files from versions lower than 1.1
if [ -e ${ADDON_DIR}/eufySecurityApi ]; then
  if [ -e ${ADDON_DIR}/eufySecurityApi/http/http.service.js ]; then
    rm -f ${ADDON_DIR}/eufySecurityApi/http/http.service.js
  fi
  if [ -e ${ADDON_DIR}/eufySecurityApi/http/http.utils.js ]; then
    rm -f ${ADDON_DIR}/eufySecurityApi/http/http.utils.js
  fi
  if [ -e ${ADDON_DIR}/eufySecurityApi/http/http-request.models.js ]; then
    rm -f ${ADDON_DIR}/eufySecurityApi/http/http-request.models.js
  fi
  if [ -e ${ADDON_DIR}/eufySecurityApi/http/http-response.models.js ]; then
    rm -f ${ADDON_DIR}/eufySecurityApi/http/http-response.models.js
  fi
  if [ -e ${ADDON_DIR}/eufySecurityApi/p2p/cloud-lookup.service.js ]; then
    rm -f ${ADDON_DIR}/eufySecurityApi/p2p/cloud-lookup.service.js
  fi
  if [ -e ${ADDON_DIR}/eufySecurityApi/p2p/command.model.js ]; then
    rm -f ${ADDON_DIR}/eufySecurityApi/p2p/command.model.js
  fi
  if [ -e ${ADDON_DIR}/eufySecurityApi/p2p/device-client.service.js ]; then
    rm -f ${ADDON_DIR}/eufySecurityApi/p2p/device-client.service.js
  fi
  if [ -e ${ADDON_DIR}/eufySecurityApi/p2p/ip.utils.js ]; then
    rm -f ${ADDON_DIR}/eufySecurityApi/p2p/ip.utils.js
  fi
  if [ -e ${ADDON_DIR}/eufySecurityApi/p2p/local-lookup.service.js ]; then
    rm -f ${ADDON_DIR}/eufySecurityApi/p2p/local-lookup.service.js
  fi
  if [ -e ${ADDON_DIR}/eufySecurityApi/p2p/message.utils.js ]; then
    rm -f ${ADDON_DIR}/eufySecurityApi/p2p/message.utils.js
  fi
  if [ -e ${ADDON_DIR}/eufySecurityApi/p2p/payload.utils.js ]; then
    rm -f ${ADDON_DIR}/eufySecurityApi/p2p/payload.utils.js
  fi
  if [ -e ${ADDON_DIR}/eufySecurityApi/push/fid.model.js ]; then
    rm -f ${ADDON_DIR}/eufySecurityApi/push/fid.model.js
  fi
  if [ -e ${ADDON_DIR}/eufySecurityApi/push/push.model.js ]; then
    rm -f ${ADDON_DIR}/eufySecurityApi/push/push.model.js
  fi
  if [ -e ${ADDON_DIR}/eufySecurityApi/push/push.utils.js ]; then
    rm -f ${ADDON_DIR}/eufySecurityApi/push/push.utils.js
  fi
  if [ -e ${ADDON_DIR}/eufySecurityApi/push/push-client.service.js ]; then
    rm -f ${ADDON_DIR}/eufySecurityApi/push/push-client.service.js
  fi
  if [ -e ${ADDON_DIR}/eufySecurityApi/push/push-client-parser.service.js ]; then
    rm -f ${ADDON_DIR}/eufySecurityApi/push/push-client-parser.service.js
  fi
  if [ -e ${ADDON_DIR}/eufySecurityApi/push/push-register.service.js ]; then
    rm -f ${ADDON_DIR}/eufySecurityApi/push/push-register.service.js
  fi
fi

# remove unused node_modules files from versions lower than 1.1
if [ -e ${ADDON_DIR}/eufySecurityApi/node_modules/.bin ]; then
  rm -r ${ADDON_DIR}/eufySecurityApi/node_modules
fi

# create necessary directories
mkdir -p ${ADDON_DIR}
chmod 755 ${ADDON_DIR}
mkdir -p ${RCD_DIR}
chmod 755 ${RCD_DIR}

# copy addon files
cp -af eufySecurity/* ${ADDON_DIR}/
cp -af eufySecurity-addon.cfg ${ADDON_DIR}/
cp -af VERSION ${ADDON_DIR}/

# make node executable
chmod 755 ${ADDON_DIR}/bin/node

# exclude some directories from backup
# (user will NEED to reinstall plugin after restore)
touch ${ADDON_DIR}/bin/.nobackup
touch ${ADDON_DIR}/node_modules/.nobackup

# copy startup script
cp -af rc.d/* ${RCD_DIR}
chmod 755 ${RCD_DIR}/eufySecurity

# create www link
if [ ! -e ${WWW_DIR} ]; then
  ln -sf ${ADDON_DIR}/www ${WWW_DIR}
fi

sync

# exit with 0 to signal install succeeded
# if device is raspberrymatic then no reboot is requiered
# and so we must start the service
# the original ccu will restart by default
if [ "$1" = "HM-RASPBERRYMATIC" ]; then
  ${RCD_DIR}/eufySecurity start
fi
exit 0